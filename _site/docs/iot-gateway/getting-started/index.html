

<!Doctype html>
<html id="docs" class="Thingsboard IoT Gateway">



<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Getting started with Thingsboard IoT Gateway - Thingsboard</title>
<meta property="og:title" content="Getting started with Thingsboard IoT Gateway" />
<meta name="description" content="Write your first IoT project using Thingsboard IoT Gateway" />
<meta property="og:description" content="Write your first IoT project using Thingsboard IoT Gateway" />
<link rel="canonical" href="http://localhost:4000/docs/iot-gateway/getting-started/" />
<meta property="og:url" content="http://localhost:4000/docs/iot-gateway/getting-started/" />
<meta property="og:site_name" content="Thingsboard" />
<meta property="og:image" content="http://localhost:4000/images/thingsboard_logo.png" />
<meta name="twitter:image" content="http://localhost:4000/images/thingsboard_logo.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@thingsboard" />
<meta name="twitter:creator" content="@thingsboard" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebPage",
    "headline": "Getting started with Thingsboard IoT Gateway",
    "image": "http://localhost:4000/images/thingsboard_logo.png",
    "description": "Write your first IoT project using Thingsboard IoT Gateway",
    "logo": "http://localhost:4000/images/thingsboard_logo.png",
    "url": "http://localhost:4000/docs/iot-gateway/getting-started/"
  }
</script>
<!-- End Jekyll SEO tag -->
	
	
	<link rel="shortcut icon" type="image/png" href="/images/favicon.png">

	<link rel="stylesheet" href="/css/styles.css">
	<script type="text/javascript">
		/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
		!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
		/*! onloadCSS. (onload callback for loadCSS) [c]2017 Filament Group, Inc. MIT License */
		function onloadCSS(a,b){function c(){!d&&b&&(d=!0,b.call(a))}var d;a.addEventListener&&a.addEventListener("load",c),a.attachEvent&&a.attachEvent("onload",c),"isApplicationInstalled"in navigator&&"onloadcssdefined"in a&&a.onloadcssdefined(c)}
	</script>
	<script type="text/javascript">

		function jqueryDefer(method) {
			if (window.jQuery) {
				method();
			} else {
				setTimeout(function() {
					jqueryDefer(method)
				}, 50);
			}
		}

		function jqueryUiDefer(method) {
			if (window.jQuery && window.jQuery.ui) {
				method();
			} else {
				setTimeout(function() {
					jqueryUiDefer(method)
				}, 50);
			}
		}

		function loadScript(src, callback)
		{
			var s, r, t;
			r = false;
			s = document.createElement('script');
			s.type = 'text/javascript';
			s.src = src;
			s.onload = s.onreadystatechange = function() {
				if ( !r && (!this.readyState || this.readyState == 'complete') )
				{
					r = true;
					if (callback) {
						callback();
					}
				}
			};
			t = document.getElementsByTagName('script')[0];
			t.parentNode.insertBefore(s, t);
		}

		function loadCssAsync(src, callback) {
			var stylesheet = loadCSS( src );
			if (callback) {
				onloadCSS(stylesheet, callback);
			}
		}

		function loadNextScript(index, scriptsList, completeCallback) {
			if (index < scriptsList.length) {
				var script = scriptsList[index];
				if (script.type === 'script') {
					loadScript(script.src, function() {
						index++;
						loadNextScript(index, scriptsList, completeCallback);
					});
				} else if (script.type === 'css') {
					loadCssAsync(script.src, function() {
						index++;
						loadNextScript(index, scriptsList, completeCallback);
					});
				}
			} else if (completeCallback) {
				completeCallback();
			}
		}

		var initialScriptsList = [
			{src: '/js/jquery-2.2.0.min.js', type: 'script'},
			{src: '/css/jquery-ui.min.css', type: 'css'},
			{src: '/js/jquery-ui.min.js', type: 'script'},
			{src: '/js/script.js', type: 'script'},
			{src: '/css/sweetalert.css', type: 'css'},
			{src: '/js/sweetalert.min.js', type: 'script'}
		];

		loadNextScript(0, initialScriptsList);

	</script>
	<script type="text/javascript">
		function _gaLt(event) {
			/* If GA is blocked or not loaded, or not main|middle|touch click then don't track */
			if (!ga.hasOwnProperty("loaded") || ga.loaded != true || (event.which != 1 && event.which != 2)) {
				return;
			}
			var el = event.srcElement || event.target;

			while (el && (typeof el.tagName == 'undefined' || el.tagName.toLowerCase() != 'a' || !el.href)) {
				el = el.parentNode;
			}
			if (el && el.href) {
				var link = el.href;
				if ((link.indexOf(location.host) == -1 || link.indexOf('.' + location.host) > 0) && !link.match(/^javascript\:/i)) {
					var target = (el.target && !el.target.match(/^_(self|parent|top)$/i)) ? el.target : false;
					if (event.ctrlKey || event.shiftKey || event.metaKey || event.which == 2) {
						target = "_blank";
					}

					var hbrun = false; // tracker has not yet run
					var hitBack = function() {
						if (hbrun) return;
						hbrun = true;
						window.location.href = link;
					};

					if (target) {
						ga(
								"send", "event", "Outgoing Links", link,
								document.location.pathname + document.location.search
						);
					} else {
						event.preventDefault ? event.preventDefault() : event.returnValue = !1;
						ga(
								"send", "event", "Outgoing Links", link,
								document.location.pathname + document.location.search, {
									"hitCallback": hitBack
								}
						);

						setTimeout(hitBack, 1000);
					}
				}
			}
		}

		var _w = window;
		var _gaLtEvt = ("ontouchstart" in _w) ? "click" : "mousedown";
		_w.addEventListener ? _w.addEventListener("load", function() {document.body.addEventListener(_gaLtEvt, _gaLt, !1)}, !1)
				: _w.attachEvent && _w.attachEvent("onload", function() {document.body.attachEvent("on" + _gaLtEvt, _gaLt)});
	</script>
</head>
<body>
<div id="cellophane" onclick="tb.toggleMenu()"></div>
<header>
	<a href="#" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="#" class="button" id="viewDocs" data-auto-burger-exclude>&nbsp;&nbsp;主要功能&nbsp;&nbsp;</a>
		<a href="#" class="button" id="useCases" data-auto-burger-exclude>&nbsp;&nbsp;查看文档&nbsp;&nbsp;</a>
		<a href="#" class="button" id="useCases" data-auto-burger-exclude>&nbsp;&nbsp;案例分析&nbsp;&nbsp;</a>
		<a href="#" class="button" id="gettingStarted" data-auto-burger-exclude>&nbsp;&nbsp;开始使用&nbsp;&nbsp;</a>
		<button id="hamburger" onclick="tb.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main id="headNav" data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="#">开始使用<a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">查看文档</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">案例分析</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="http://osswangxining.github.io/">Blog</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">服务支持</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">联系我们</a></h3>
			</div>
		</main>

	</nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
  <h1>Thingsboard IoT Gateway</h1>
  <h5>Integrate legacy and third-party systems with Thingsboard platform using IoT Gateway.</h5>
  <div id="vendorStrip" class="light-text">
    <div id="docsList">
        <ul>
          <li><a href="/docs/" >DOCS HOME</a></li>
          <li><a href="/docs/api/" >API</a></li>
          <li><a href="/docs/iot-gateway/" class="YAH">IOT GATEWAY</a></li>
          <li><a href="/docs/reference/" >REFERENCE</a></li>
          <li><a href="/docs/samples/" >SAMPLES</a></li>
          <li><a href="/iot-use-cases/" >USE CASES</a></li>
          <li><a href="/docs/iot-video-tutorials/" >VIDEO TUTORIALS</a></li>
          <li><a href="/docs/faq/" >FAQ</a></li>
          <li><a href="/docs/services/" >SERVICES</a></li>
          <li><a href="/docs/contact-us/" >CONTACT US</a></li>
        </ul>
    </div>
    <div id="searchBox">
      <input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)">
    </div>
  </div>
</section>





<section id="encyclopedia">
  
  <div id="docsToc" >
        <div class="pi-accordion">
        
    <a class="item" data-title="IoT Gateway" href="/docs/iot-gateway/"></a>
    <a class="item" data-title="What is Thingsboard IoT Gateway?" href="/docs/iot-gateway/what-is-iot-gateway/"></a>
    <a class="item" data-title="Getting Started" href="/docs/iot-gateway/getting-started/"></a>
<div class="item" data-title="Installation guide">
  <div class="container">
    <a class="item" data-title="Installation options" href="/docs/iot-gateway/installation/"></a>
    <a class="item" data-title="Windows" href="/docs/iot-gateway/install/windows/"></a>
    <a class="item" data-title="Linux (Ubuntu & CentOS)" href="/docs/iot-gateway/install/linux/"></a>
    <a class="item" data-title="Raspberry Pi" href="/docs/iot-gateway/install/rpi/"></a>
    <a class="item" data-title="Building from sources" href="/docs/iot-gateway/install/building-from-source/"></a>
    <a class="item" data-title="Upgrade instructions" href="/docs/iot-gateway/install/upgrade-instructions/"></a>
  </div>
</div>
<div class="item" data-title="Configuration guide">
  <div class="container">
    <a class="item" data-title="General configuration" href="/docs/iot-gateway/configuration/"></a>
    <a class="item" data-title="OPC-UA Extension" href="/docs/iot-gateway/opc-ua/"></a>
    <a class="item" data-title="MQTT Extension" href="/docs/iot-gateway/mqtt/"></a>
    <a class="item" data-title="Sigfox Extension" href="/docs/iot-gateway/sigfox/"></a>
  </div>
</div>
        </div> <!-- /pi-accordion -->
    <button class="push-menu-close-button" onclick="tb.toggleToc()"></button>
  </div> <!-- /docsToc -->
  
  <div id="docsContent" class="">
    <h1>Getting started with Thingsboard IoT Gateway</h1>
    <ul id="markdown-toc">
  <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li>
  <li><a href="#step-1-choose-installation-option" id="markdown-toc-step-1-choose-installation-option">Step 1: Choose installation option</a></li>
  <li><a href="#step-2-follow-installation-steps" id="markdown-toc-step-2-follow-installation-steps">Step 2: Follow installation steps</a></li>
  <li><a href="#step-3-gateway-provisioning" id="markdown-toc-step-3-gateway-provisioning">Step 3: Gateway provisioning</a></li>
  <li><a href="#step-4-gateway-configuration" id="markdown-toc-step-4-gateway-configuration">Step 4: Gateway configuration</a></li>
  <li><a href="#step-5-launch-your-gateway" id="markdown-toc-step-5-launch-your-gateway">Step 5. Launch your gateway</a></li>
  <li><a href="#step-6-review-gateway-statistics" id="markdown-toc-step-6-review-gateway-statistics">Step 6. Review gateway statistics</a></li>
  <li><a href="#step-7-choose-your-extension" id="markdown-toc-step-7-choose-your-extension">Step 7. Choose your extension</a></li>
  <li><a href="#step-8-connect-to-external-mqtt-broker" id="markdown-toc-step-8-connect-to-external-mqtt-broker">Step 8. Connect to external MQTT broker</a>    <ul>
      <li><a href="#step-81-basic-mapping-example" id="markdown-toc-step-81-basic-mapping-example">Step 8.1 Basic mapping example</a></li>
      <li><a href="#step-82-mapping-json-arrays" id="markdown-toc-step-82-mapping-json-arrays">Step 8.2 Mapping JSON arrays</a></li>
      <li><a href="#step-83-mapping-mqtt-topic-to-device-name" id="markdown-toc-step-83-mapping-mqtt-topic-to-device-name">Step 8.3 Mapping MQTT topic to device name</a></li>
      <li><a href="#step-84-advanced-mapping-syntax-and-filtering" id="markdown-toc-step-84-advanced-mapping-syntax-and-filtering">Step 8.4 Advanced mapping syntax and filtering</a></li>
      <li><a href="#step-85-custom-mqtt-message-mappers" id="markdown-toc-step-85-custom-mqtt-message-mappers">Step 8.5 Custom MQTT message mappers</a></li>
    </ul>
  </li>
  <li><a href="#step-9-connect-to-external-opc-ua-server" id="markdown-toc-step-9-connect-to-external-opc-ua-server">Step 9. Connect to external OPC-UA server</a>    <ul>
      <li><a href="#step-91-provision-gateway-credentials-to-kepserverex" id="markdown-toc-step-91-provision-gateway-credentials-to-kepserverex">Step 9.1. Provision gateway credentials to KEPServerEX</a></li>
      <li><a href="#step-92-add-server-endpoint-kepserverex" id="markdown-toc-step-92-add-server-endpoint-kepserverex">Step 9.2. Add server endpoint KEPServerEX</a></li>
      <li><a href="#step-93-enable-opc-ua-extension" id="markdown-toc-step-93-enable-opc-ua-extension">Step 9.3. Enable OPC-UA extension</a></li>
      <li><a href="#step-94-explore-data-from-devices" id="markdown-toc-step-94-explore-data-from-devices">Step 9.4. Explore data from devices</a></li>
    </ul>
  </li>
  <li><a href="#step-10-connect-to-sigfox-backend" id="markdown-toc-step-10-connect-to-sigfox-backend">Step 10. Connect to Sigfox Backend</a>    <ul>
      <li><a href="#step-101-sigfox-backend-configuration" id="markdown-toc-step-101-sigfox-backend-configuration">Step 10.1 Sigfox Backend configuration</a></li>
      <li><a href="#step-102-basic-mapping-example" id="markdown-toc-step-102-basic-mapping-example">Step 10.2 Basic mapping example</a></li>
      <li><a href="#step-103-dry-run" id="markdown-toc-step-103-dry-run">Step 10.3 Dry Run</a></li>
      <li><a href="#step-104-custom-data-type-transformers" id="markdown-toc-step-104-custom-data-type-transformers">Step 10.4 Custom Data type transformers</a></li>
    </ul>
  </li>
  <li><a href="#next-steps" id="markdown-toc-next-steps">Next steps</a></li>
</ul>

<p>This guide covers initial IoT Gateway installation and configuration.
We will connect IoT Gateway to Thingsboard server and visualize some basic gateway statistics: amount of devices connected and messages processed.
We will also configure MQTT and OPC-UA extension in order to subscribe to device data feed from external devices or applications.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>If you don’t have access to a running Thingsboard instance, use either <a href="https://demo.thingsboard.io/signup"><strong>Live Demo</strong></a> or 
<a href="/docs/user-guide/install/installation-options/"><strong>Installation Guide</strong></a> 
to fix this.</p>

<p><strong>NOTE</strong> Thingsboard version 1.1 or greater is required.</p>

<h2 id="step-1-choose-installation-option">Step 1: Choose installation option</h2>

<p>Browse available gateway <a href="/docs/iot-gateway/installation/"><strong>installation options</strong></a> and choose the most suitable installation guide.</p>

<h2 id="step-2-follow-installation-steps">Step 2: Follow installation steps</h2>

<p>Follow steps (1-3) in the chosen gateway installation guide. The Gateway configuration steps are covered below.</p>

<h2 id="step-3-gateway-provisioning">Step 3: Gateway provisioning</h2>

<p>In order to connect your IoT gateway to Thingsboard server you need to provision gateway credentials first. We will use access token credentials as the most simple one. 
See <a href="/docs/user-guide/device-credentials/">device authentication options</a> for more details.</p>

<p>Login as tenant administrator. Use <a href="/docs/samples/demo-account/#demo-tenant">default credentials</a> in case of local Thingsboard server.
Open <strong>Devices</strong> and click on big red “+” button in the bottom right corner.</p>

<p style="text-align: center;"><img src="/images/gateway/device-page.png" alt="image" /></p>

<p>Populate your gateway name and select “Is gateway” checkbox.</p>

<p style="text-align: center;"><img src="/images/gateway/device-add.png" alt="image" /></p>

<p><strong>NOTE:</strong> Gateway and device names should be unique in scope of tenant.</p>

<p>Open new device card and click on “Copy Access Token” button.</p>

<p style="text-align: center;"><img src="/images/gateway/device-token.png" alt="image" /></p>

<h2 id="step-4-gateway-configuration">Step 4: Gateway configuration</h2>

<p>Navigate to gateway configuration folder and edit <strong>tb-gateway.yml</strong> file.
Configuration folder location:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/conf
Linux: /etc/tb-gateway/conf
</code></pre>
</div>

<p>Change <strong>gateway.connection.host</strong> property to your Thingsboard host (leave without modifications in case of live demo instance).</p>

<p>Change <strong>gateway.connection.security.accessToken</strong> property to your access token that was copied during step 3.</p>

<p>You gateway configuration should look similar to this file:</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>
gateway:
  reporting:
    interval: 60000
  persistence:
    type: file
    path: storage
    bufferSize: 1000
  connection:
    host: "demo.thingsboard.io"
    port: 1883
    retryInterval: 3000
    maxInFlight: 1000
    security:
      accessToken: YOUR_ACCESS_TOKEN_HERE

opc:
  enabled: false
  configuration: opc-config.json

mqtt:
  enabled: false
  configuration: mqtt-config.json

server:
  address: "0.0.0.0"
  port: "9090"
</code></pre>
</div>

<h2 id="step-5-launch-your-gateway">Step 5. Launch your gateway</h2>

<p>Follow steps (5-6) in the chosen installation guide.</p>

<h2 id="step-6-review-gateway-statistics">Step 6. Review gateway statistics</h2>

<p>Open the web UI of your Thingsboard server and review statistics that is uploaded from your thingsboard gateway.
Login as Tenant Administrator and open <strong>Devices</strong> page. Click on the gateway device card. 
Open “Latest Telemetry” tab and review following statistics: “<strong>devicesOnline</strong>”, “<strong>attributesUploaded</strong>” and “<strong>telemetryUploaded</strong>”.
All values should be set to “0”.</p>

<p style="text-align: center;"><img src="/images/gateway/gateway-statistics.png" alt="image" /></p>

<p>The presence of those values on the UI means that your gateway have successfully connected to Thingsboard server.</p>

<h2 id="step-7-choose-your-extension">Step 7. Choose your extension</h2>

<p>Based on your use case, you can choose following options:</p>

<ul>
  <li>connect to <a href="/docs/iot-gateway/getting-started/#step-8-connect-to-external-mqtt-broker"><strong>MQTT broker</strong></a></li>
  <li>connect to <a href="/docs/iot-gateway/getting-started/#step-9-connect-to-external-opc-ua-server"><strong>OPC-UA server</strong></a></li>
  <li>connect to <a href="/docs/iot-gateway/getting-started/#step-10-connect-to-sigfox-backend"><strong>Sigfox Backend</strong></a></li>
</ul>

<p>or follow instruction for all steps.</p>

<h2 id="step-8-connect-to-external-mqtt-broker">Step 8. Connect to external MQTT broker</h2>

<p>In this step we will connect to external MQTT broker in order to start collecting data from legacy or third-party applications and devices.</p>

<p>Navigate to gateway configuration folder and edit <strong>tb-gateway.yml</strong> file.
Configuration folder location:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/conf
Linux: /etc/tb-gateway/conf
</code></pre>
</div>

<p>Change <strong>mqtt.enabled</strong> property value to <strong>true</strong>.</p>

<p>We will use Mosquitto MQTT broker for the demonstration purposes. See Mosquitto <a href="https://mosquitto.org/download/">downloads page</a> for instructions how to install this broker.</p>

<p><strong>NOTE:</strong> Mosquitto and Thingsboard use same port (1883) for MQTT service. If you want to use Thingsboard and Mosquitto on the same host, you need to change mqtt port in one of the servers.
See corresponding <a href="/docs/user-guide/install/config/">Thingsboard</a> or <a href="https://mosquitto.org/man/mosquitto-conf-5.html">Mosquitto</a> documentation for more details.</p>

<p>Since we use Thingsboard <a href="https://demo.thingsboard.io/signup">demo instance</a> hosted in the cloud, we will install Mosquitto MQTT broker locally and use default service configuration.</p>

<p>If you decide to use other MQTT broker that is deployed to external host or has specific security configuration, please edit <strong>mqtt-config.json</strong> file and modify connection parameters.
See MQTT extension <a href="/docs/iot-gateway/mqtt/">configuration guide</a> for more details.</p>

<p>Restart your gateway using following commands</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: 
net stop tb-gateway
net start tb-gateway
Linux: 
sudo service tb-gateway restart
</code></pre>
</div>

<p>The <strong>mqtt-config.json</strong> contains sample configuration that allows mapping of JSON messages from external MQTT broker to Thingsboard device attributes and telemetry.</p>

<h3 id="step-81-basic-mapping-example">Step 8.1 Basic mapping example</h3>

<p>For example, the default mapping listed below will force gateway to subscribe to the <strong>sensors</strong> topic and use <strong>serialNumber</strong> from incoming json message as a device name.
Similar, <strong>model</strong> and <strong>temperature</strong> json object fields will be mapped to corresponding Thingsboard device attribute and telemetry fields.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"topicFilter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sensors"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"converter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"filterExpression"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"deviceNameJsonExpression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.serialNumber}"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"model"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.model}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"timeseries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"temperature"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.temperature}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Let’s see this mapping in action. We will use <strong>mosquitto_pub</strong> command to emulate data from device that is connected to external mqtt broker:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mosquitto_pub -h localhost -p 1883 -t <span class="s2">"sensors"</span> -m <span class="s1">'{"serialNumber":"SN-001", "model":"T1000", "temperature":36.6}'</span>
</code></pre>
</div>

<p>You should observe following log message in the gateway logs:</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>... INFO  o.t.g.service.MqttGatewayService - [SN-001] Device Connected!
</code></pre>
</div>
<p>Logs are located in the following folder:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/logs
Linux: /var/log/tb-gateway
</code></pre>
</div>

<p>Now you can navigate to the Thingsboard Web UI and observe new device <strong>SN-001</strong> on the <strong>Devices</strong> page.
You can click on the device card and observe delivered attributes and telemetry in the corresponding tabs.</p>

<p style="text-align: center;"><img src="/images/gateway/device-model-attribute.png" alt="image" /></p>

<h3 id="step-82-mapping-json-arrays">Step 8.2 Mapping JSON arrays</h3>

<p>By default, gateway supports mapping of json arrays, by mapping each array element as a separate entity. For example, following command will create or update two devices: <strong>SN-002</strong> and <strong>SN-003</strong>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mosquitto_pub -h localhost -p 1883 -t <span class="s2">"sensors"</span> -m <span class="s1">'[{"serialNumber":"SN-002", "model":"M2", "temperature":42.0}, {"serialNumber":"SN-003", "model":"M3", "temperature":73.0}]'</span>
</code></pre>
</div>

<h3 id="step-83-mapping-mqtt-topic-to-device-name">Step 8.3 Mapping MQTT topic to device name</h3>

<p>In some cases, device name is a part of the MQTT topic. In this case you are able to use regular expression to extract device name value. 
This regular expression is configured in the <strong>deviceNameTopicExpression</strong> field.</p>

<p>See example publish command and mapping (already present in default configuration) below:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mosquitto_pub -h localhost -p 1883 -t <span class="s2">"sensor/SN-004/temperature"</span> -m <span class="s1">'{"value":36.6}'</span>
</code></pre>
</div>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"topicFilter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sensor/+/temperature"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"converter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"filterExpression"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"deviceNameTopicExpression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(?&lt;=sensor\/)(.*?)(?=\/temperature)"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"timeseries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"temperature"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.value}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h3 id="step-84-advanced-mapping-syntax-and-filtering">Step 8.4 Advanced mapping syntax and filtering</h3>

<p>Gateway MQTT extension uses <a href="https://github.com/jayway/JsonPath"><strong>JsonPath</strong></a> library to provide ability of flexible mapping and filtering of JSON structures.
You can define filterExpression based on the <a href="https://github.com/jayway/JsonPath#path-examples"><strong>path</strong></a> and <a href="https://github.com/jayway/JsonPath#filter-operators"><strong>filter</strong></a> examples.</p>

<h3 id="step-85-custom-mqtt-message-mappers">Step 8.5 Custom MQTT message mappers</h3>

<p>As a gateway developer, you are able to fork and add custom mappers using following <a href="https://github.com/thingsboard/thingsboard-gateway/blob/release-1.0/src/main/java/org/thingsboard/gateway/extensions/mqtt/client/conf/mapping/MqttDataConverter.java">interface</a>. 
Feel free to submit PRs with your custom mapper implementations if you believe that they may be useful for Thingsboard community.</p>

<h2 id="step-9-connect-to-external-opc-ua-server">Step 9. Connect to external OPC-UA server</h2>

<p>This example will demonstrate how to</p>

<ul>
  <li>connect to your local KEPServerEX installation running on Windows.</li>
  <li>transform sample OPC-UA tag values to Thingsboard attributes and telemetry.</li>
  <li>visualize OPC-UA tag values using Thingsboard widgets.</li>
</ul>

<p>We assume that KEPServerEX is already installed on your Windows machine. 
We will use Windows 10 and <a href="https://my.kepware.com/download/demo/ex/?utm_content=">Free Demo</a> server.</p>

<h3 id="step-91-provision-gateway-credentials-to-kepserverex">Step 9.1. Provision gateway credentials to KEPServerEX</h3>

<p>Open KEPServerEX “OPC UA Configuration Manager” application and navigate to “Trusted Clients” page.</p>

<p>Import <strong>example.der</strong> certificate from the gateway configuration folder. Configuration folder location:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/conf
Linux: /etc/tb-gateway/conf
</code></pre>
</div>

<p><strong>NOTE</strong> This certificate is added to the configuration folder for the demonstration purposes. Both certificate and key is in public access, thus it is not secure and is not for production usage.
You can create and configure your own certificate pair for production usage.</p>

<p style="text-align: center;"><img src="/images/gateway/certificate-import.png" alt="image" /></p>

<h3 id="step-92-add-server-endpoint-kepserverex">Step 9.2. Add server endpoint KEPServerEX</h3>

<p>This step is required if you want to deploy Thingsboard IoT Gateway and KEPServerEX on different hosts.</p>

<p>KEPServerEX need to be configured to accept remote connections. Open KEPServerEX “OPC UA Configuration Manager” application and navigate to “Server Endpoints” page.</p>

<p style="text-align: center;"><img src="/images/gateway/server-endpoint.png" alt="image" /></p>

<p><strong>NOTE</strong> KEPServerEX restart is required.</p>

<h3 id="step-93-enable-opc-ua-extension">Step 9.3. Enable OPC-UA extension</h3>

<p>Navigate to gateway configuration folder and edit <strong>tb-gateway.yml</strong> file.
Configuration folder location:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/conf
Linux: /etc/tb-gateway/conf
</code></pre>
</div>

<p>Change <strong>opc.enabled</strong> property value to <strong>true</strong>.</p>

<p>If you decide to use different OPC-UA server that is deployed to external host or has specific security configuration, please edit <strong>opc-config.json</strong> file and modify connection parameters.
See OPC-UA extension <a href="/docs/iot-gateway/opc-ua/">configuration guide</a> for more details.</p>

<p>Restart your gateway using following commands</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: 
net stop tb-gateway
net start tb-gateway
Linux: 
sudo service tb-gateway restart
</code></pre>
</div>

<h3 id="step-94-explore-data-from-devices">Step 9.4. Explore data from devices</h3>

<p>The <strong>opc-config.json</strong> contains sample configuration that allows mapping of OPC-UA tags to Thingsboard device attributes and telemetry.
Once started, OPC-UA extension will monitor your OPC-UA server using this pre-defined configuration.</p>

<p>For example, the default mapping listed below will force gateway to treat all OPC-UA tags that match <strong>deviceNodePattern</strong> as Thingsboard devices.
Gateway will use <strong>deviceNamePattern</strong> to calculate the device name based on values of different tags using relative to device node tag (For example, <strong>_System._DeviceId</strong>).
Similar, <strong>Tag1</strong> and <strong>Tag2</strong> relative OPC-UA tags will be mapped to corresponding Thingsboard device attribute and telemetry fields.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"deviceNodePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Channel1\\.Device\\d+$"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"deviceNamePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Device ${_System._DeviceId}"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nt">"key"</span><span class="p">:</span><span class="s2">"Tag1"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${Tag1}"</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"timeseries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nt">"key"</span><span class="p">:</span><span class="s2">"Tag2"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${Tag2}"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>You should observe following log message in the gateway logs:</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>... INFO  o.t.g.service.MqttGatewayService - [Device 1] Device Connected!
</code></pre>
</div>

<p>Logs are located in the following folder:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/logs
Linux: /var/log/tb-gateway
</code></pre>
</div>

<p>Now you can navigate to the Thingsboard Web UI and observe new device <strong>Device 1</strong> on the <strong>Devices</strong> page.
You can click on the device card and observe delivered attributes and telemetry in the corresponding tabs.</p>

<p style="text-align: center;"><img src="/images/gateway/device-opc-telemetry.png" alt="image" /></p>

<h2 id="step-10-connect-to-sigfox-backend">Step 10. Connect to Sigfox Backend</h2>

<p>In this step we will connect to Sigfox Backend in order to start collecting data from sigfox modules.</p>

<p>Navigate to gateway configuration folder and edit <strong>tb-gateway.yml</strong> file.
Configuration folder location:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: YOUR_INSTALL_DIR/conf
Linux: /etc/tb-gateway/conf
</code></pre>
</div>

<p>Change <strong>sigfox.enabled</strong> property value to <strong>true</strong>.</p>

<p>Restart your gateway using following commands</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Windows: 
net stop tb-gateway
net start tb-gateway
Linux: 
sudo service tb-gateway restart
</code></pre>
</div>

<p>The <strong>sigfox-config.json</strong> contains configuration that allows mapping of JSON messages from Sigfox Backend to Thingsboard telemetry.</p>

<h3 id="step-101-sigfox-backend-configuration">Step 10.1 Sigfox Backend configuration</h3>

<p>Let’s assume we want to publish coordinates, temperature and humidity data from your Sigfox module to Thingsboard.
In order to achieve this, you will need to select device type and configure custom callback from Sigfox Backend to our IoT Gateway.</p>

<p style="text-align: center;"><img src="/images/gateway/sigfox/4.sigfox_device_type_callback_configuration.jpg" alt="image" /></p>

<p>Few things to notice:</p>

<ul>
  <li>This is <strong>UPLINK</strong> data callback;</li>
  <li><strong>URL pattern</strong> contains IoT Gateway host, port and device type id;</li>
  <li><strong>Authorization</strong> header is used to authenticate Sigfox server;</li>
  <li><strong>POST</strong> HTTP method is required;</li>
  <li>Message body is a <strong>valid</strong> JSON document;</li>
  <li>Message body uses <strong>regular variables</strong>: device, lat, lng;</li>
  <li>Message body uses <strong>custom variables</strong> which are case sensitive: Temperature and Humidity.</li>
</ul>

<p>We assume you have deployed the gateway on some cloud server to get the static IP address or hostname.</p>

<h3 id="step-102-basic-mapping-example">Step 10.2 Basic mapping example</h3>

<p>The default mapping listed below will allow to convert data from Sigfox Backend and publish it to Thingsboard.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"deviceTypeConfigurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"deviceTypeId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOUR_DEVICE_TYPE_ID"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SECURITY_TOKEN"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"converter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"deviceNameJsonExpression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.device}"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lat"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.lat}"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lng"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.lng}"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nt">"timeseries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"temperature"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.data.temperature}"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"transformer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"intToDouble"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"double"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"humidity"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${$.data.humidity}"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"transformer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"intToDouble"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Few things to notice:</p>

<ul>
  <li><strong>YOUR_DEVICE_TYPE_ID</strong> need to be replaced with the actual value (“58cb911a5005742b3b4c41a0” in our case)</li>
  <li><strong>SECURITY_TOKEN</strong> need to be replaced with the random value (“Basic U0lHRk9YX1RFU1RfVE9LRU4=” in our case)</li>
  <li><strong><a href="https://github.com/jayway/JsonPath">JsonPath</a></strong> expression are used to extract values from incoming JSON (“$.data.temperature” in our case).</li>
  <li><strong>All</strong> JsonPath expressions need to be placed into <strong>${}</strong>.</li>
  <li><strong>Transformers</strong> are used to convert data types. For example, integer to double using “(65536-X)/10” formula. You can plugin your own converters.</li>
</ul>

<h3 id="step-103-dry-run">Step 10.3 Dry Run</h3>

<p>Once your Sigfox Beckend callback is configured, you may observe incoming messages in Thingsboard IoT Gateway logs.
If everything is configured correctly, you will see new devices in your Tenant Administrator device list.</p>

<p style="text-align: center;"><img src="/images/gateway/sigfox/devices.png" alt="image" /></p>

<p>You are able to open particular device and check that telemetry values arrived successfully.</p>

<h3 id="step-104-custom-data-type-transformers">Step 10.4 Custom Data type transformers</h3>

<p>As a gateway developer, you are able to fork and add custom transformers using following <a href="https://github.com/thingsboard/thingsboard-gateway/blob/release-1.2/src/main/java/org/thingsboard/gateway/extensions/sigfox/conf/mapping/DataValueTransformer.java">interface</a>. 
Feel free to submit PRs with your custom transformer implementations if you believe that they may be useful for Thingsboard community.</p>

<h2 id="next-steps">Next steps</h2>

<p>Explore guides related to main Thingsboard features:</p>

<ul>
  <li><a href="/docs/user-guide/visualization/">Data Visualization</a> - how to visualize collected data.</li>
  <li><a href="/docs/user-guide/attributes/">Device attributes</a> - how to use device attributes.</li>
  <li><a href="/docs/user-guide/telemetry/">Telemetry data collection</a> - how to collect telemetry data.</li>
  <li><a href="/docs/user-guide/rpc/">Using RPC capabilities</a> - how to send commands to/from devices.</li>
  <li><a href="/docs/user-guide/rule-engine/">Rule Engine</a> - how to use rule engine to analyze data from devices.</li>
</ul>


  </div>
</section>

<footer>
	<main class="light-text">
		
		<div id="miceType" class="center">&copy; 2016 - 2017 IoT套件</div>
	</main>

</footer>



<button class="flyout-button" onclick="tb.toggleToc()"></button>


<style>
  .cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
  }
  .gsc-control-cse table, .gsc-control-cse-en table {
    margin:0px !important;
  }
  .gsc-above-wrapper-area {
    border-bottom: 0;
  }
</style>
</body>
</html>
