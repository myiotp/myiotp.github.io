

<!Doctype html>
<html id="docs" class="Samples">



<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Alarms based on sensor readings - Thingsboard</title>
<meta property="og:title" content="Alarms based on sensor readings" />
<meta name="description" content="Triggering email alarms based on IoT sensor readings and configurable thresholds" />
<meta property="og:description" content="Triggering email alarms based on IoT sensor readings and configurable thresholds" />
<link rel="canonical" href="http://localhost:4000/docs/samples/alarms/basic-rules/" />
<meta property="og:url" content="http://localhost:4000/docs/samples/alarms/basic-rules/" />
<meta property="og:site_name" content="Thingsboard" />
<meta property="og:image" content="http://localhost:4000/images/thingsboard_logo.png" />
<meta name="twitter:image" content="http://localhost:4000/images/thingsboard_logo.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@thingsboard" />
<meta name="twitter:creator" content="@thingsboard" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebPage",
    "headline": "Alarms based on sensor readings",
    "image": "http://localhost:4000/images/thingsboard_logo.png",
    "description": "Triggering email alarms based on IoT sensor readings and configurable thresholds",
    "logo": "http://localhost:4000/images/thingsboard_logo.png",
    "url": "http://localhost:4000/docs/samples/alarms/basic-rules/"
  }
</script>
<!-- End Jekyll SEO tag -->
	
	
	<link rel="shortcut icon" type="image/png" href="/images/favicon.png">

	<link rel="stylesheet" href="/css/styles.css">
	<script type="text/javascript">
		/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
		!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
		/*! onloadCSS. (onload callback for loadCSS) [c]2017 Filament Group, Inc. MIT License */
		function onloadCSS(a,b){function c(){!d&&b&&(d=!0,b.call(a))}var d;a.addEventListener&&a.addEventListener("load",c),a.attachEvent&&a.attachEvent("onload",c),"isApplicationInstalled"in navigator&&"onloadcssdefined"in a&&a.onloadcssdefined(c)}
	</script>
	<script type="text/javascript">

		function jqueryDefer(method) {
			if (window.jQuery) {
				method();
			} else {
				setTimeout(function() {
					jqueryDefer(method)
				}, 50);
			}
		}

		function jqueryUiDefer(method) {
			if (window.jQuery && window.jQuery.ui) {
				method();
			} else {
				setTimeout(function() {
					jqueryUiDefer(method)
				}, 50);
			}
		}

		function loadScript(src, callback)
		{
			var s, r, t;
			r = false;
			s = document.createElement('script');
			s.type = 'text/javascript';
			s.src = src;
			s.onload = s.onreadystatechange = function() {
				if ( !r && (!this.readyState || this.readyState == 'complete') )
				{
					r = true;
					if (callback) {
						callback();
					}
				}
			};
			t = document.getElementsByTagName('script')[0];
			t.parentNode.insertBefore(s, t);
		}

		function loadCssAsync(src, callback) {
			var stylesheet = loadCSS( src );
			if (callback) {
				onloadCSS(stylesheet, callback);
			}
		}

		function loadNextScript(index, scriptsList, completeCallback) {
			if (index < scriptsList.length) {
				var script = scriptsList[index];
				if (script.type === 'script') {
					loadScript(script.src, function() {
						index++;
						loadNextScript(index, scriptsList, completeCallback);
					});
				} else if (script.type === 'css') {
					loadCssAsync(script.src, function() {
						index++;
						loadNextScript(index, scriptsList, completeCallback);
					});
				}
			} else if (completeCallback) {
				completeCallback();
			}
		}

		var initialScriptsList = [
			{src: '/js/jquery-2.2.0.min.js', type: 'script'},
			{src: '/css/jquery-ui.min.css', type: 'css'},
			{src: '/js/jquery-ui.min.js', type: 'script'},
			{src: '/js/script.js', type: 'script'},
			{src: '/css/sweetalert.css', type: 'css'},
			{src: '/js/sweetalert.min.js', type: 'script'}
		];

		loadNextScript(0, initialScriptsList);

	</script>
	<script type="text/javascript">
		function _gaLt(event) {
			/* If GA is blocked or not loaded, or not main|middle|touch click then don't track */
			if (!ga.hasOwnProperty("loaded") || ga.loaded != true || (event.which != 1 && event.which != 2)) {
				return;
			}
			var el = event.srcElement || event.target;

			while (el && (typeof el.tagName == 'undefined' || el.tagName.toLowerCase() != 'a' || !el.href)) {
				el = el.parentNode;
			}
			if (el && el.href) {
				var link = el.href;
				if ((link.indexOf(location.host) == -1 || link.indexOf('.' + location.host) > 0) && !link.match(/^javascript\:/i)) {
					var target = (el.target && !el.target.match(/^_(self|parent|top)$/i)) ? el.target : false;
					if (event.ctrlKey || event.shiftKey || event.metaKey || event.which == 2) {
						target = "_blank";
					}

					var hbrun = false; // tracker has not yet run
					var hitBack = function() {
						if (hbrun) return;
						hbrun = true;
						window.location.href = link;
					};

					if (target) {
						ga(
								"send", "event", "Outgoing Links", link,
								document.location.pathname + document.location.search
						);
					} else {
						event.preventDefault ? event.preventDefault() : event.returnValue = !1;
						ga(
								"send", "event", "Outgoing Links", link,
								document.location.pathname + document.location.search, {
									"hitCallback": hitBack
								}
						);

						setTimeout(hitBack, 1000);
					}
				}
			}
		}

		var _w = window;
		var _gaLtEvt = ("ontouchstart" in _w) ? "click" : "mousedown";
		_w.addEventListener ? _w.addEventListener("load", function() {document.body.addEventListener(_gaLtEvt, _gaLt, !1)}, !1)
				: _w.attachEvent && _w.attachEvent("onload", function() {document.body.attachEvent("on" + _gaLtEvt, _gaLt)});
	</script>
</head>
<body>
<div id="cellophane" onclick="tb.toggleMenu()"></div>
<header>
	<a href="#" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="#" class="button" id="viewDocs" data-auto-burger-exclude>&nbsp;&nbsp;主要功能&nbsp;&nbsp;</a>
		<a href="#" class="button" id="useCases" data-auto-burger-exclude>&nbsp;&nbsp;查看文档&nbsp;&nbsp;</a>
		<a href="#" class="button" id="useCases" data-auto-burger-exclude>&nbsp;&nbsp;案例分析&nbsp;&nbsp;</a>
		<a href="#" class="button" id="gettingStarted" data-auto-burger-exclude>&nbsp;&nbsp;开始使用&nbsp;&nbsp;</a>
		<button id="hamburger" onclick="tb.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main id="headNav" data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="#">开始使用<a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">查看文档</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">案例分析</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="http://osswangxining.github.io/">Blog</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">服务支持</a></h3>
			</div>
			<div class="nav-box">
				<h3><a href="#">联系我们</a></h3>
			</div>
		</main>

	</nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
  <h1>Samples</h1>
  <h5>A collection of example applications that show how to use Thingsboard.</h5>
  <div id="vendorStrip" class="light-text">
    <div id="docsList">
        <ul>
          <li><a href="/docs/" >DOCS HOME</a></li>
          <li><a href="/docs/api/" >API</a></li>
          <li><a href="/docs/iot-gateway/" >IOT GATEWAY</a></li>
          <li><a href="/docs/reference/" >REFERENCE</a></li>
          <li><a href="/docs/samples/" class="YAH">SAMPLES</a></li>
          <li><a href="/iot-use-cases/" >USE CASES</a></li>
          <li><a href="/docs/iot-video-tutorials/" >VIDEO TUTORIALS</a></li>
          <li><a href="/docs/faq/" >FAQ</a></li>
          <li><a href="/docs/services/" >SERVICES</a></li>
          <li><a href="/docs/contact-us/" >CONTACT US</a></li>
        </ul>
    </div>
    <div id="searchBox">
      <input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)">
    </div>
  </div>
</section>





<section id="encyclopedia">
  
  <div id="docsToc" >
        <div class="pi-accordion">
        
    <a class="item" data-title="Samples" href="/docs/samples/"></a>
    <a class="item" data-title="Live Demo Server" href="/docs/user-guide/live-demo/"></a>
    <a class="item" data-title="Local Demo Account" href="/docs/samples/demo-account/"></a>
<div class="item" data-title="Hardware samples">
  <div class="container">
<div class="item" data-title="Arduino">
  <div class="container">
    <a class="item" data-title="Arduino overview" href="/docs/samples/arduino/"></a>
    <a class="item" data-title="Temperature upload over MQTT using Arduino UNO, ESP8266 and DHT22 sensor" href="/docs/samples/arduino/temperature/"></a>
  </div>
</div>
<div class="item" data-title="ESP8266">
  <div class="container">
    <a class="item" data-title="ESP8266 overview" href="/docs/samples/esp8266/"></a>
    <a class="item" data-title="Temperature upload over MQTT using ESP8266 and DHT22 sensor" href="/docs/samples/esp8266/temperature/"></a>
    <a class="item" data-title="ESP8266 GPIO control over MQTT using Thingsboard" href="/docs/samples/esp8266/gpio/"></a>
  </div>
</div>
<div class="item" data-title="NodeMCU">
  <div class="container">
    <a class="item" data-title="NodeMCU overview" href="/docs/samples/nodemcu/"></a>
    <a class="item" data-title="Temperature upload over MQTT using NodeMCU and DHT11 sensor" href="/docs/samples/nodemcu/temperature/"></a>
  </div>
</div>
<div class="item" data-title="Raspberry Pi">
  <div class="container">
    <a class="item" data-title="Raspberry Pi overview" href="/docs/samples/raspberry/"></a>
    <a class="item" data-title="Raspberry Pi GPIO control over MQTT using Thingsboard" href="/docs/samples/raspberry/gpio/"></a>
    <a class="item" data-title="Raspberry Pi GPIO control using Android Things and Thingsboard" href="/docs/samples/raspberry/gpio-android-things/"></a>
    <a class="item" data-title="Temperature upload over MQTT using Raspberry Pi and DHT22 sensor" href="/docs/samples/raspberry/temperature/"></a>
  </div>
</div>
<div class="item" data-title="LinkIt ONE">
  <div class="container">
    <a class="item" data-title="LinkIt ONE overview" href="/docs/samples/linkit-one/"></a>
    <a class="item" data-title="GPS data upload and visualization using LinkIt ONE and Thingsboard" href="/docs/samples/linkit-one/gps/"></a>
  </div>
</div>
  </div>
</div>
<div class="item" data-title="Tutorials">
  <div class="container">
<div class="item" data-title="Alarms">
  <div class="container">
    <a class="item" data-title="Sending Alarms using Email Plugin" href="/docs/samples/alarms/mail/"></a>
    <a class="item" data-title="Alarms based on devices attributes and sensor readings" href="/docs/samples/alarms/basic-rules/"></a>
  </div>
</div>
    <a class="item" data-title="Facilities Monitoring PoC" href="/docs/samples/monitoring/facilities-monitoring-poc/"></a>
  </div>
</div>
        </div> <!-- /pi-accordion -->
    <button class="push-menu-close-button" onclick="tb.toggleToc()"></button>
  </div> <!-- /docsToc -->
  
  <div id="docsContent" class="">
    <h1>Alarms based on sensor readings</h1>
    <ul id="markdown-toc">
  <li><a href="#assumptions" id="markdown-toc-assumptions">Assumptions</a></li>
  <li><a href="#how-it-works" id="markdown-toc-how-it-works">How it works?</a></li>
  <li><a href="#device-provisioning" id="markdown-toc-device-provisioning">Device provisioning</a>    <ul>
      <li><a href="#step-1-create-device" id="markdown-toc-step-1-create-device">Step 1. Create Device</a></li>
      <li><a href="#step-2-provision-zoneid-and-zonetype-attributes" id="markdown-toc-step-2-provision-zoneid-and-zonetype-attributes">Step 2. Provision ZoneID and ZoneType attributes</a></li>
    </ul>
  </li>
  <li><a href="#rule-configuration" id="markdown-toc-rule-configuration">Rule configuration</a>    <ul>
      <li><a href="#step-3-create-server-room-monitoring-rule" id="markdown-toc-step-3-create-server-room-monitoring-rule">Step 3. Create “Server Room Monitoring” Rule</a></li>
      <li><a href="#step-4-message-type-filter" id="markdown-toc-step-4-message-type-filter">Step 4. Message type filter</a></li>
      <li><a href="#step-5-attributes-filter" id="markdown-toc-step-5-attributes-filter">Step 5. Attributes filter</a></li>
      <li><a href="#step-6-telemetry-filter" id="markdown-toc-step-6-telemetry-filter">Step 6. Telemetry filter</a></li>
      <li><a href="#step-7-alarm-processor" id="markdown-toc-step-7-alarm-processor">Step 7. Alarm Processor</a></li>
      <li><a href="#step-8-rule-action" id="markdown-toc-step-8-rule-action">Step 8. Rule Action</a></li>
      <li><a href="#step-9-save-and-activate-rule" id="markdown-toc-step-9-save-and-activate-rule">Step 9. Save and Activate Rule</a></li>
    </ul>
  </li>
  <li><a href="#dry-run" id="markdown-toc-dry-run">Dry run</a></li>
  <li><a href="#troubleshooting" id="markdown-toc-troubleshooting">Troubleshooting</a></li>
</ul>

<p>This tutorial will demonstrate how to configure Rule that will generate Alarm when certain device reports temperature or humidity that exceeds certain thresholds.</p>

<p>Lets assume that we have devices that are able to report humidity and temperature values. 
We have one device per room (zone) in the building or other facility and we want to specify different rules based on zone type.</p>

<h2 id="assumptions">Assumptions</h2>

<p>We assume you have already configured email plugin that will distribute generated alarms to recepients. You can follow previous <a href="/docs/samples/alarms/mail/">tutorial</a> to do this.</p>

<h2 id="how-it-works">How it works?</h2>

<p>We will provision simple rule that filters incoming data using:</p>

<ul>
  <li>“Message type” filter to react on telemetry data.</li>
  <li>“Device Attributes” filter to process data from device that has certain room type as a server side attribute.</li>
  <li>“Device Telemetry” filter to detect humidity and temperature values that are out of pre-configured range.</li>
</ul>

<h2 id="device-provisioning">Device provisioning</h2>

<p>Let’s create a Device and provision certain server-side attributes: ZoneId and ZoneType.</p>

<h4 id="step-1-create-device">Step 1. Create Device</h4>

<p>Navigate to <a href="https://demo.thingsboard.io/devices">devices</a> page and click on big red “+” button. Populate device name and description and click “Add” button.</p>

<p><img src="/images/samples/alarms/add-device.png" alt="image" /></p>

<h4 id="step-2-provision-zoneid-and-zonetype-attributes">Step 2. Provision ZoneID and ZoneType attributes</h4>

<p>Open device card that you have created. Navigate to “Attributes” tab and select “Server” attributes scope.</p>

<p><img src="/images/samples/alarms/server-attributes-table.png" alt="image" /></p>

<p>Click on the highlighted “+” button. Add two attributes “ZoneId” and “ZoneType” as shown below. We will use them later in the rule filters.</p>

<p><img src="/images/samples/alarms/zone-id.png" alt="image" />
<img src="/images/samples/alarms/zone-type.png" alt="image" /></p>

<h2 id="rule-configuration">Rule configuration</h2>

<h4 id="step-3-create-server-room-monitoring-rule">Step 3. Create “Server Room Monitoring” Rule</h4>

<p>Navigate to <a href="https://demo.thingsboard.io/rules">rules</a> page and click on big red “+” button. Populate rule name and description first.</p>

<p><img src="/images/samples/alarms/add-rule.png" alt="image" /></p>

<p>Our rule will contain three filters as described in “<a href="#how-it-works">how it works</a>” section.</p>

<h4 id="step-4-message-type-filter">Step 4. Message type filter</h4>

<p>Add filter based on message type (see image below).</p>

<p><img src="/images/samples/alarms/msg-filter.png" alt="image" /></p>

<h4 id="step-5-attributes-filter">Step 5. Attributes filter</h4>

<p>Add filter based on the server-side attributes (see image below).</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="k">typeof</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">ZoneType</span> <span class="o">!==</span> <span class="s1">'undefined'</span> <span class="o">&amp;&amp;</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">ZoneType</span> <span class="o">===</span> <span class="s1">'Server Room'</span>
</code></pre>
</div>

<p><img src="/images/samples/alarms/attributes-filter.png" alt="image" /></p>

<h4 id="step-6-telemetry-filter">Step 6. Telemetry filter</h4>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">(</span>
    <span class="k">typeof</span> <span class="nx">temperature</span> <span class="o">!==</span> <span class="s1">'undefined'</span> 
    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">temperature</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">||</span> <span class="nx">temperature</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span>
<span class="p">)</span>
<span class="o">||</span> 
<span class="p">(</span>
    <span class="k">typeof</span> <span class="nx">humidity</span> <span class="o">!==</span> <span class="s1">'undefined'</span> 
    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">humidity</span> <span class="o">&lt;=</span> <span class="mi">40</span> <span class="o">||</span> <span class="nx">humidity</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>

<p>Add filter based on the sensor reading (see image below).</p>

<p><img src="/images/samples/alarms/telemetry-filter.png" alt="image" /></p>

<h4 id="step-7-alarm-processor">Step 7. Alarm Processor</h4>

<p>Let’s add simple processor that will generate and save alarm to the database based on templates below.</p>

<p>Alarm ID:</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>[$date.get('yyyy-MM-dd HH:mm')] $ss.get('ZoneId') HVAC malfunction detected!
</code></pre>
</div>

<p>Alarm Body:</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>[$date.get('yyyy-MM-dd HH:mm:ss')] $ss.get('ZoneId') HVAC malfunction detected. 
Temperature - $temperature.valueAsString (°C). 
Humidity - $humidity.valueAsString (%)!
</code></pre>
</div>

<p><img src="/images/samples/alarms/add-processor.png" alt="image" /></p>

<p><strong>NOTE</strong> Alarm Id is a unique identifier. If there will be multiple events that match filters, alarms will be de-duplicated based on the Alarm Id. 
Email will be sent once per alarm.</p>

<p>In our case we use timestamp that is truncated to minutes to make sure that we will send email once per minute or less frequently.</p>

<h4 id="step-8-rule-action">Step 8. Rule Action</h4>

<p>Select “SendGrid Email Plugin” from previous <a href="/docs/samples/alarms/mail/">tutorial</a> and click on “Create” button.
Don’t forget to replace “thingsboard@gmail.com” with your mail address.</p>

<p><img src="/images/samples/alarms/add-action.png" alt="image" /></p>

<h4 id="step-9-save-and-activate-rule">Step 9. Save and Activate Rule</h4>

<p>Once rule is saved successfully, don’t forget to activate it by clicking on “Activate” button (see image below).</p>

<p><img src="/images/samples/alarms/activate-rule.png" alt="image" /></p>

<h2 id="dry-run">Dry run</h2>

<p>Let’s check our configuration by publishing some telemetry data. We will use access token from the device that we have created on the <a href="#step1-create-device">first step</a>.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>mosquitto_pub -d -h <span class="s2">"demo.thingsboard.io"</span> -t <span class="s2">"v1/devices/me/telemetry"</span> -u <span class="s2">"</span><span class="nv">$YOUR_ACCESS_TOKEN</span><span class="s2">"</span> -m <span class="s2">"{'temperature':42, 'humidity':74}"</span>
</code></pre>
</div>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>If you have configured something wrong, you should see errors logged on the corresponding tab:</p>

<p><img src="/images/samples/alarms/rule-events.png" alt="image" /></p>

<p>If there is no error in the rule, but you can’t see the email - check errors in the target plugin.</p>

  </div>
</section>

<footer>
	<main class="light-text">
		
		<div id="miceType" class="center">&copy; 2016 - 2017 IoT套件</div>
	</main>

</footer>



<button class="flyout-button" onclick="tb.toggleToc()"></button>


<style>
  .cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
  }
  .gsc-control-cse table, .gsc-control-cse-en table {
    margin:0px !important;
  }
  .gsc-above-wrapper-area {
    border-bottom: 0;
  }
</style>
</body>
</html>
